name: Markdown Translation

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  get-files:
    if: github.event.issue.pull_request && github.event.comment.body == '@github /translate'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_files: ${{ steps.changed-files.outputs.any_changed }}
      pr_ref: ${{ steps.get-pr.outputs.ref }}
    steps:
      - name: Get PR details
        id: get-pr
        run: |
          PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.event.issue.pull_request.url }}")
          echo "ref=$(echo $PR_DATA | jq -r .head.ref)" >> $GITHUB_OUTPUT
          echo "sha=$(echo $PR_DATA | jq -r .head.sha)" >> $GITHUB_OUTPUT
          echo "base=$(echo $PR_DATA | jq -r .base.ref)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.get-pr.outputs.ref }}
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          base_sha: origin/${{ steps.get-pr.outputs.base }}
          files: |
            **.md
          files_ignore: |
            **.ja.md
            **.zh-TW.md
            **.zh-CN.md

      - name: Set matrix
        id: set-matrix
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          files=(${{ steps.changed-files.outputs.all_changed_files }})
          matrix=$(printf '%s\n' "${files[@]}" | jq -R . | jq -s -c .)
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  translate:
    needs: get-files
    if: needs.get-files.outputs.has_files == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.get-files.outputs.matrix) }}
        lang:
          - code: japanese
            suffix: ja
          - code: simplified chinese
            suffix: zh-CN
          - code: traditional chinese
            suffix: zh-TW
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.get-files.outputs.pr_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install gpt4free
        run: |
          python -m pip install --upgrade pip
          pip install -U g4f[all]

      - name: Translate file
        run: |
          cat << 'EOF' > translate.py
          import sys
          import g4f
          from g4f.client import Client

          def translate_text(file_path, target_lang, output_path):
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()

              client = Client()

              # システムプロンプトで翻訳を指示
              prompt = f"Translate the following Markdown content to {target_lang}. Keep the original Markdown structure, formatting, and code blocks. Only return the translated text without any explanation.\n\n{content}"

              try:
                  response = client.chat.completions.create(
                      model="gpt-4o-mini",
                      messages=[{"role": "user", "content": prompt}]
                  )
                  translated_text = response.choices[0].message.content

                  with open(output_path, 'w', encoding='utf-8') as f:
                      f.write(translated_text)
                  print(f"Successfully translated: {output_path}")
              except Exception as e:
                  print(f"Error during translation: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              translate_text(sys.argv[1], sys.argv[2], sys.argv[3])
          EOF

          base="${{ matrix.file }}"
          base="${base%.md}"
          output_file="${base}.${{ matrix.lang.suffix }}.md"

          python translate.py "${{ matrix.file }}" "${{ matrix.lang.code }}" "$output_file"

      - name: Upload translated file
        uses: actions/upload-artifact@v4
        with:
          name: translated-${{ matrix.lang.suffix }}-${{ hashFiles(matrix.file) }}
          path: "**.${{ matrix.lang.suffix }}.md"
          retention-days: 1

  commit:
    needs: [get-files, translate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.get-files.outputs.pr_ref }}
          fetch-depth: 0

      - name: Download all translations
        uses: actions/download-artifact@v4
        with:
          pattern: translated-*
          merge-multiple: true

      - name: Commit all translations
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "*.md"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add translations for modified markdown files"
            git push origin HEAD:${{ needs.get-files.outputs.pr_ref }}
          fi
